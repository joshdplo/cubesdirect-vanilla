<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../../partials/head'); %>
</head>

<body>
  <%- include ('../../partials/header') %>

  <main data-cmp="checkout">
    <h1>Checkout</h1>

    <%# Cart Items %>
    <h2>Your Order</h2>
    <ul>
      <% items.forEach(item => {%>
      <li class="product">
        <img src="<%= item.Product.images[0] %>" alt="<%= item.Product.name %>" width="100">
        <div><%= item.Product.name %></div>
        <div>Quantity: <%= item.quantity %></div>
        <div>Price: $<%= item.Product.price %></div>
      </li>
      <% }); %>
      <hr>
      <h2>Subtotal: $<%= subtotal.toFixed(2) %></h2>
      <br><br>
    </ul>
    <hr>

    <%# Shipping Address Forms %>
    <h2>Shipping Address</h2>
    <% let defaultAddressIndex = null; %>
    <% if (!isGuest && addresses?.length) { %>
    <% addresses.forEach((addr, index) => { if(addr.default) defaultAddressIndex = index})%>
    <button class="checkout_show-address-form <%= defaultAddressIndex === null ? 'hide' : '' %>">Enter a New
      Address</button><br>
    <h3>Or select a saved address below</h3>
    <form id="checkout-user-address">
      <select name="addressIndex"
        value="<%= (defaultAddressIndex || defaultAddressIndex === 0) ? defaultAddressIndex : 'new' %>">
        <option value="new">Enter New Address</option>
        <% addresses.forEach((address, index) => { %>
        <option value="<%= index %>" <%if(index === defaultAddressIndex) {%>selected="true"
          <%}%>><%= address.title %></option>
          <% });%>
      </select>
      <div class="checkout_user-addresses">
        <% addresses.forEach((address, index) => { %>
        <div data-index="<%= index %>" <% if(defaultAddressIndex !== index) { %>class="hide" <% } %>>
          <%= `${address.firstName} ${address.lastName}` %><br>
          <%= address.street %><br>
          <%= `${address.city}, ${address.state} ${address.zip}` %>
        </div>
        <% });%>
      </div>
      <div class="messages"></div>
      <input type="submit" value="Proceed to Payment">
    </form>
    <% } %>
    <div class="checkout_new-address <%= defaultAddressIndex !== null ? 'hide' : '' %>">
      <%- include('../../partials/address-form', {formId: 'checkout-new-address', submitText: 'Proceed to Payment', formClass: null, formIndex: null, address: null}) %>
    </div>
  </main>

  <%- include ('../../partials/footer') %>
  <%- include ('../../partials/end') %>
</body>

</html>